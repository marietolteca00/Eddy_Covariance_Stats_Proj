---
title: "Evapotranspiration and Temperature in Camarillo, CA"
subtitle: "From California Irrigation Managment Information System (CIMIS) Station"
author: "Marie Tolteca"
format: html
editor: visual
---

# Import Libraries

```{r, message=FALSE}
library(tidyverse)
library(here)
library(dplyr)
library(patchwork)
library(knitr)
library(lubridate)
```

# Importing Data

```{r, message=FALSE, output = FALSE}
eto <- read_csv(here("data/daily_eto_variance_CAM.csv"), 
                        show_col_types = FALSE) %>% 
  janitor::clean_names()

daily <- read_csv(here("data/daily_data_CAM.csv"),
                      # R suggested to use
                      show_col_types = FALSE) %>%
  # Helps not have 'qc...6, etc'
  janitor::clean_names()
head(eto)
```

# Data Cleaning

```{r, message=FALSE}

# Dropping columns that have `qc`
# ETO Dataset
drop <- c("qc_6", "qc_8")
eto[ , !(names(eto) %in% drop)]

# DAILY Dataset
drops <- c("qc_")
daily[ , !(names(daily) %in% drops)]
```

## There is a columnn called 'Average ETo (in)' in the dataset. The Station itself has already calculated the Evapotranspiration using the Penman-Monteith (PM) equation.

$$
ET_0 = \frac{0.408 \, \Delta \, (R_n - G) + \gamma \frac{900}{T+273} \, u_2 \, (e_s - e_a)}{\Delta + \gamma (1 + 0.34 \, u_2)}
$$

In this project I will use the *Total ETo column* as my *Response Variable*. The *predictor variables* will be *Average Air Temperature (F)* as well as *Total Precipitation (in)*

## DAG Model

```{r}

knitr::include_graphics(here::here("images/DAG.png"))

```

# Data Exploratory

```{r}
hist(daily$e_to_in)
#hist(daily$precip_in)
#hist(daily$temp)

p1 <- ggplot(data = daily,
       aes(x = e_to_in)) +
  geom_histogram() +
  geom_vline(xintercept = mean(daily$e_to_in),
             color = "red",
             linetype = "dashed",
             linewidth = 1)
p1

```


```{r}
# Data type
class(daily$date)

#summary(daily)
names(daily)

# Check NA's
colSums(is.na(daily))
colSums(is.na(eto))


```

```{r}
map1<- ggplot(data = daily, aes(x = precip_in, y = e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, Daily ET Over A Year")+
  theme_linedraw()

map2<-ggplot(data = daily, aes(x = avg_air_temp_f, y = e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, Daily ET Over A Year")+
  theme_linedraw()

(map1+map2)
```

```{r}
map3 <- ggplot(data = eto, aes(x = date, y = avg_e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, ET Over A Year")+
  theme_linedraw()
map4 <-ggplot(data = daily, aes(x = date, y = avg_air_temp_f)) +
  geom_point() +
  labs(title = "Camarillo, Daily Temp Over A Year")+
  theme_linedraw()

(map3+map4)
```

# Joining Data
Data needs to be merged, to combine Precipitation and Temperature from the same station. To combine data it will be a left join using the date column since both datasets have a date column.
```{r}
daily_eto <- left_join(eto, daily, by = "date") %>% 
  janitor::clean_names() %>% 
  # Remove ALL columns that start with "qc_" - Not needed
  select(!starts_with("qc_")) %>% 
  # Drop double column of site name, number, and region
  select(!starts_with(c("cimis_region_y","stn_name_y","stn_id_y")))

# Checking NA's
colSums(is.na(daily_eto))

# View first 5 rows
head(daily_eto)

```

# After Joining plot
View how all the three variables (ETo, Precipitation, and Temperature) look in a scatterplot.
```{r}
ggplot(data = daily_eto, aes(x = precip_in, 
                             y = avg_air_temp_f)) +
  # Fill points using ETo
  geom_point(aes(color = e_to_in)) +
  labs(title = "Viewing Variables",
       subtitle = "ETo, Prepicitation, and Temperature",
       x = "Precipitation (in)",
       y = "Average Air Temperature (F)",
       fill = "ETo")+
  theme_linedraw()
```
In this figure we can see if there is a higher average air temperature (F) we can expect more ETo, compared to Precipitation. 

# Hypothesis:

1)  State your hypothesis for your final project. Using this week's wildfire lab as an example, your hypothesis could be "The number of wildfires increases with vapor pressure deficit." That's an example of a scientific hypothesis. To state the equivalent statistical hypothesis, you first need a model. That's the second goal of this checkpoint.

-   `Evapotranspiration (ETo) increases with higher air temperature and decreases with higher precipitation.`

$$
\begin{align}

    {Eto} &\sim{Gamma(\mu,\phi)}
    
\end{align}
$$

$$
\begin{align}
log(\mu) = β0 + β1(Precipitation) + β2(Temperature)
\end{align} 
$$

- Mu = mean
- Alpha = shape parameter

- Evapotranspiration (ETo) is driven by vapor pressure deficit, radiation, and temperature. On days with higher precipitation, ETo tends to decrease because of cloud cover, lower radiation, and higher humidity.

2)  Describe your model in statistical notation using the appropriate response family, link function, and predictors. Then use your model to state a statistical hypothesis. Using the wildfire lab again as an example, your statistical hypothesis would be "H0: β_1 = 0; HA: β_1 \> 0".

-   I model daily ETo for the Camarillo station using:

$$
\begin{align}
Precipitation: 
H0 : B1 = 0 \\
HA : B1 < 0 \\
\end{align}
$$


\$\$ *(Null : When there is no precipitation ETo stays the same. Alt: When there is precipitation, ETo decreases. )*


$$
\begin{align}
Temperature: 
H0 : B1 = 0 \\
HA : B1 > 0
\end{align}
$$


*(Null: When Temperature is the same, Eto stays the same. Alt: When Temperature increase there is more ETo)*

-   Eto = evapotranspiration (inches)
-   Precipitation = Daily Precipitation (inches)
-   Temperature = Average Daily Air Temperature (Farenheit)
-   Using a Gamma Model and a link of a log allows to have fitted values of 0-1 remain positive.

# Attempt at creating glm and interpretting results

Interested in Evapotranspiration (eto) and average temperature (avg_air_temp_f) in the location of Camarillo, California.

```{r}
# This will remove any negative integers
daily_eto <- daily_eto %>%
  # e_to_in is used since we are grabbing daily numbers
  mutate(e_to_in_adj = e_to_in + 1e-6)


# Gamma regression for daily ETo
cam_gamma <- glm(
  # Response ~ Predictor + Predictor
  e_to_in_adj ~ precip_in + avg_air_temp_f,
  data = daily_eto,
  family = Gamma(link = "log"))


# Look at results
summary(cam_gamma)

# equation
cam_gamma$formula

# Extract coefficients
B0 <- cam_gamma$coef[1]
B1 <- cam_gamma$coef[2]
B2 <- cam_gamma$coef[3]


#Sigma and mean? Do not pop up with `$`

```

"B0 = `r round(B0, 2)` (β₀): The expected ETo when precipitation (in) and temperature (F) are equal to 0."

"B1 = `r round(B1, 2)` (β₁): For every 1-inch increase in precipitation,e_to_in_adj (ETo) will decrease, holding temperature constant.

"B2 = `r round(B2, 2)` (β₂): For each 1 (F) increase in mean air temperature, e_to_in_adj tends to increase, holding precipitation constant."

All three coefficients hold a value of <2e-16, this implied that all three constants are highly significant. Both predictors have a strong effect on ETo. With more rain, the lower the ETo. With higher temperature the more ETo.


# Graph/ Plot

```{r}

# A grid of predictor(s) to generate predictions for 
pred_grid <- expand.grid(
  precip_in = seq(min(daily_eto$precip_in), max(daily_eto$precip_in), 
                  length.out = 50),
  avg_air_temp_f = seq(min(daily_eto$avg_air_temp_f), max(daily_eto$avg_air_temp_f), 
                       length.out = 50))

# Generate our predictions
eto_pred <- pred_grid %>%
  mutate(phi = predict(cam_gamma, 
                          newdata = pred_grid, 
                          type = "response"))

# Plot
plot1 <- ggplot(eto_pred, aes(x = precip_in, y = avg_air_temp_f)) +
  geom_raster(aes(fill = phi)) +
  geom_contour(aes(z = phi), color = "white", alpha = 0.6) +
  # Scale - color fill
  scale_fill_viridis_c() +
  labs(
    title = "Predicted Evapotranspiration",
    subtitle = "Gamma Model",
    x = "Monthly Precipitation (in)",
    y = "Average Air Temperature (°F)",
    fill = "Predicted\nETo"
  ) +
  theme_light()

plot2<- ggplot(eto_pred, aes(x = precip_in, y = phi, color = avg_air_temp_f)) +
  geom_point(alpha = 0.5) +
  geom_line() +
  scale_color_viridis_c() +
  labs(
    title = "Predicted ETo vs Precipitation",
    subtitle = "Gamma GLM with log link",
    x = "Precipitation (in)",
    y = "Predicted ETo (in)",
    color = "Temperature (°F)"
  ) +
  theme_minimal()

plot1+plot2

# Filter temperature to not have so many values next to each other and should be good
# 
```

Hypothesis: (Eto decreases on wetter days) & (Eto increases with temperature) Interp: In the figure shown above, the

*Interp*:





# Simulation 
Using Rgamma (n, shape, scale)

```{r}
set.seed(42)

# Define the number of observations
n <- 10000

# Simulate the two predictor variables
# You can choose any distribution for your predictors
x1 <- rnorm(n, mean = 0, sd = 2) # 0–2 inches #PRECIP
x2 <- runif(n, min = 0, max = 10)# avg temp # TEMP

# Define the true coefficients for your model
# These coefficients determine the relationship between predictors and the mean of y
beta0 <- 1    # Intercept - # ETo
beta1 <- 0.5  # Coefficient for x1 - # Precipitation decreases with Eto
beta2 <- -0.2 # Coefficient for x2 - # Temperature increases with Eto

# Calculate the expected mean of y (lambda) based on predictors and coefficients
# Using a log-link function, as is common for Gamma GLMs
mu <- exp(beta0 + beta1 * x1 + beta2 * x2)

# Define the dispersion parameter (or a fixed shape/rate)
phi <- 2 # A fixed shape parameter

# Calculate the scale parameter based on the mean and shape
# Mean = shape * scale, so scale = Mean / shape
scale_param <- mu / phi

# 6. Simulate the Gamma-distributed outcome variable 'y'
y <- rgamma(n, shape = shape_param, scale = scale_param)

# 7. Combine the simulated data into a data frame
simulated_data <- data.frame(
  precip = x1,
  temp = x2,
  rgamma = y)

# 8. (Optional) Verify the simulation by fitting a Gamma GLM
# This helps check if the simulated data reflects the intended relationships
sim_model <- glm(y ~ precip + temp, 
                 family = Gamma(link = "log"), 
                 data = simulated_data)
summary(sim_model)

# beta_0 <- sim_model$coefficients[1]
# beta1 <- sim_model$coefficients[2]
# beta2 <- sim_model$coefficients[3]

```




# References

-   Gamma Positive Continuous Data Part 1: Intro, Mean-Variance Relationship.RPub.`https://rpubs.com/anangwe/1261395`
- Micheal Foley. Gamma Distribution. January 17, 2029.`https://rpubs.com/mpfoley73/459051`


