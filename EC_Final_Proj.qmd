---
title: "Evapotranspiration and Temperature in Camarillo, CA"
subtitle: "From California Irrigation Managment Information System (CIMIS) Station"
author: "Marie Tolteca"
format: html
editor: visual
---

# Import Libraries

```{r, message=FALSE}
library(tidyverse)
library(here)
library(dplyr)
library(patchwork)
library(knitr)
library(lubridate)
```

# Importing Data

```{r, message=FALSE, output = FALSE}
eto <- read_csv(here("data/daily_eto_variance_CAM.csv"), 
                        show_col_types = FALSE) %>% 
  janitor::clean_names()

daily <- read_csv(here("data/daily_data_CAM.csv"),
                      # R suggested to use
                      show_col_types = FALSE) %>%
  # Helps not have 'qc...6, etc'
  janitor::clean_names()
head(eto)
```

# Data Cleaning

```{r, message=FALSE}

# Dropping columns that have `qc`
# ETO Dataset
drop <- c("qc_6", "qc_8")
eto[ , !(names(eto) %in% drop)]

# DAILY Dataset
drops <- c("qc_")
daily[ , !(names(daily) %in% drops)]
```

## There is a columnn called 'Average ETo (in)' in the dataset. The Station itself has already calculated the Evapotranspiration using the Penman-Monteith (PM) equation.

$$
ET_0 = \frac{0.408 \, \Delta \, (R_n - G) + \gamma \frac{900}{T+273} \, u_2 \, (e_s - e_a)}{\Delta + \gamma (1 + 0.34 \, u_2)}
$$

In this project I will use the *Total ETo column* as my *Response Variable*. The *predictor variables* will be *Average Air Temperature (F)* as well as *Total Precipitation (in)*

## DAG Model

```{r}

knitr::include_graphics(here::here("images/DAG.png"))

```

# Data Exploratory

```{r}
hist(daily$e_to_in)
#hist(daily$precip_in)
#hist(daily$temp)

ggplot(data = daily,
       aes(x = e_to_in)) +
  geom_histogram() +
  geom_vline(xintercept = mean(daily$e_to_in),
             color = "red",
             linetype = "dashed",
             linewidth = 1)


```

```{r}
ggplot(daily_eto, aes(precip_in, e_to_in)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  theme_light()
```

```{r}
# Data type
class(daily$date)

#summary(daily)
names(daily)

# Check NA's
colSums(is.na(daily))
colSums(is.na(eto))


```

```{r}
map1<- ggplot(data = daily, aes(x = precip_in, y = e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, Daily ET Over A Year")+
  theme_linedraw()

map2<-ggplot(data = daily, aes(x = avg_air_temp_f, y = e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, Daily ET Over A Year")+
  theme_linedraw()

(map1+map2)
```

```{r}
map3 <- ggplot(data = eto, aes(x = date, y = avg_e_to_in)) +
  geom_point() +
  labs(title = "Camarillo, ET Over A Year")+
  theme_linedraw()
map4 <-ggplot(data = daily, aes(x = date, y = avg_air_temp_f)) +
  geom_point() +
  labs(title = "Camarillo, Daily Temp Over A Year")+
  theme_linedraw()

(map3+map4)
```

# Joining Data

```{r}
daily_eto <- left_join(eto, daily, by = "date") %>% 
  janitor::clean_names() %>% 
  # Remove ALL columns that start with "qc_" - Not needed
  select(!starts_with("qc_")) %>% 
  # Drop double column of site name, number, and region
  select(!starts_with(c("cimis_region_y","stn_name_y","stn_id_y")))

# Checking NA's
colSums(is.na(daily_eto))

# View first 5 rows
head(daily_eto)

```

# After Joining plot

```{r}

ggplot(data = daily_eto, aes(x = precip_in, 
                             y = avg_air_temp_f, 
                             fill = e_to_in)) +
  geom_point() +
  labs(title = "ETo ")+
  theme_linedraw()
```

# Hypothesis:

1)  State your hypothesis for your final project. Using this week's wildfire lab as an example, your hypothesis could be "The number of wildfires increases with vapor pressure deficit." That's an example of a scientific hypothesis. To state the equivalent statistical hypothesis, you first need a model. That's the second goal of this checkpoint.

-   `Evapotranspiration (ETo) increases with higher air temperature and decreases with higher precipitation.`

$$
\begin{align}

    {Eto} &\sim{Gamma(mu,Î»)}\\\
    
    Online Notation: ð‘‰ð‘Žð‘Ÿ[y]=ðœ™ð‘‰(ðœ‡)
    
    
\end{align}
$$

$$
\begin{align}
log(\mu) = Î²0 + Î²1(Precipitation) + Î²2(Temperature)
\end{align} 
$$

-   Lambda = shape parameter

-   Evapotranspiration (ETo) is driven by vapor pressure deficit, radiation, and temperature. On days with higher precipitation, ETo tends to decrease because of cloud cover, lower radiation, and higher humidity.

2)  Describe your model in statistical notation using the appropriate response family, link function, and predictors. Then use your model to state a statistical hypothesis. Using the wildfire lab again as an example, your statistical hypothesis would be "H0: Î²_1 = 0; HA: Î²_1 \> 0".

-   I model daily ETo for the Camarillo station using:

$$
\begin{align}
Precipitation: 
H0 : B1 = 0 \\
HA : B1 < 0 \\
\end{align}
$$


\$\$ *(Eto decreases on wetter days)*


$$
\begin{align}
Temperature: 
H0 : B1 = 0 \\
HA : B1 > 0
\end{align}
$$


*(Eto increases with temperature)*

-   Eto = evapotranspiration (inches)
-   Precipitation = Daily Precipitation (inches)
-   Temperature = Average Daily Air Temperature (Farenheit)
-   Using a Gamma Model and a link of a log allows to have fitted values of 0-1 remain positive.

# Attempt at creating glm and interpretting results

Interested in Evapotranspiration (eto) and average temperature (avg_air_temp_f) in the location of Camarillo, California.

```{r}
# This will remove any negative integers
daily_eto <- daily_eto %>%
  mutate(e_to_in_adj = e_to_in + 1e-6)


# Gamma regression for daily ETo
cam_gamma <- glm(
  e_to_in_adj ~ precip_in + avg_air_temp_f,
  data = daily_eto,
  family = Gamma(link = "log"))


# Look at results
summary(cam_gamma)

# equation
cam_gamma$formula

# Extract coefficients
B0 <- cam_gamma$coef[1]
B1 <- cam_gamma$coef[2]
B2 <- cam_gamma$coef[3]

#Sigma and mean? Do not pop up with `$`

```

"B0 = `r round(B0, 2)` (Î²â‚€): The expected ETo when precipitation = 0 and temperature = 0Â°F."

"B1 = `r round(B1, 2)` (Î²â‚): For each 1-inch increase in precipitation, expected ETo is multiplied by exp(Î²â‚) = `-1.5` inches. This corresponds to approximately a `15%` change in ETo, holding temperature constant."

"B2 = `r round(B2, 2)` (Î²â‚‚): For each 1Â°F increase in mean air temperature, expected ETo is multiplied by exp(Î²â‚‚) = `0.046`. This corresponds to approximately a `4.6%` increase in ETo, holding precipitation constant."


# Graph/ Plot

```{r}

# A grid of predictor(s) to generate predictions for 
pred_grid <- expand.grid(
  precip_in = seq(min(daily_eto$precip_in), max(daily_eto$precip_in), 
                  length.out = 50),
  avg_air_temp_f = seq(min(daily_eto$avg_air_temp_f), max(daily_eto$avg_air_temp_f), 
                       length.out = 50))

# Generate our predictions
eto_pred <- pred_grid %>%
  mutate(lambda = predict(cam_gamma, 
                          newdata = pred_grid, 
                          type = "response"))

# Plot
ggplot(eto_pred, aes(x = precip_in, y = avg_air_temp_f)) +
  geom_raster(aes(fill = lambda)) +
  geom_contour(aes(z = lambda), color = "white", alpha = 0.6) +
  # Scale - color fill
  scale_fill_viridis_c() +
  labs(
    title = "Predicted Evapotranspiration",
    subtitle = "Gamma Model",
    x = "Monthly Precipitation (in)",
    y = "Average Air Temperature (Â°F)",
    fill = "Predicted\nETo"
  ) +
  theme_light()

```

```{r}
p1 <- ggplot(
  data = eto_pred, 
  mapping = aes(x = precip_in, y = lambda)) + 
  geom_point(aes(color=avg_air_temp_f))+
  labs(
    x= "previp",
    y= "eto",
    color = "temp" )


p1 
```

Hypothesis: (Eto decreases on wetter days) & (Eto increases with temperature) Interp: In the figure shown above, the

# References

-   Gamma Positive Continuous Data \| Part 1: Intro, Mean-Variance Relationship.RPub.https://rpubs.com/anangwe/1261395



```{r}
#test
daily_eto1 <- daily_eto %>%
  mutate(e_to_in_adj = avg_e_to_in + 1e-6) %>% 
  mutate(precip_in_avg = mean(precip_in))

# Gamma regression for daily ETo
cam_gamma <- glm(
  e_to_in_adj ~ precip_in_avg + avg_air_temp_f,
  data = daily_eto1,
  family = Gamma(link = "log"))

# A grid of predictor(s) to generate predictions for 
pred_grid1 <- expand.grid(
  precip_in_avg = seq(min(daily_eto1$precip_in_avg), max(daily_eto1$precip_in_avg), 
                  length.out = 50),
  avg_air_temp_f = seq(min(daily_eto1$avg_air_temp_f), max(daily_eto1$avg_air_temp_f), 
                       length.out = 50))

# Generate our predictions
eto_pred <- pred_grid %>%
  mutate(lambda = predict(cam_gamma, 
                          newdata = pred_grid1, 
                          type = "response"))

# Plot
ggplot(eto_pred, aes(x = precip_in_avg, y = avg_air_temp_f)) +
  geom_raster(aes(fill = lambda)) +
  geom_contour(aes(z = lambda), color = "white", alpha = 0.6) +
  # Scale - color fill
  scale_fill_viridis_c() +
  labs(
    title = "Predicted Evapotranspiration",
    subtitle = "Gamma Model",
    x = "Monthly Precipitation (in)",
    y = "Average Air Temperature (Â°F)",
    fill = "Predicted\nETo"
  ) +
  theme_light()
```

